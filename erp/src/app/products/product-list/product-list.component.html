<mat-card>
  <mat-card-header>
    <mat-card-title>Gestão de Produtos</mat-card-title>
    <span class="spacer"></span>
    <button mat-flat-button color="primary" (click)="addProduct()">
      <mat-icon>add</mat-icon>
      <span>Adicionar Artigo</span>
    </button>
  </mat-card-header>
  
  <!-- Filtros -->
  <div class="filters-container">
    <div class="filters-left">
      <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
        <mat-label>Tipo</mat-label>
        <mat-select [formControl]="productTypeFilter">
          @for (option of productTypeOptions; track option.value) {
            <mat-option [value]="option.value">
              {{option.label}}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
      
      <button 
        mat-icon-button 
        (click)="clearFilter()" 
        matTooltip="Limpar filtro"
        [disabled]="productTypeFilter.value === 'ALL'"
        class="clear-filter-btn">
        <mat-icon>clear</mat-icon>
      </button>
    </div>
    
    <!-- Contador de produtos -->
    <div class="products-counter">
      <mat-chip class="counter-chip" disabled>
        {{(products$ | async)?.length || 0}} produto(s) encontrado(s)
      </mat-chip>
    </div>
  </div>
  <mat-card-content>
    <div class="table-container mat-elevation-z8">
      <table mat-table [dataSource]="products$" class="full-width-table">

        <!-- Coluna SKU -->
        <ng-container matColumnDef="sku">
          <th mat-header-cell *matHeaderCellDef> SKU </th>
          <td mat-cell *matCellDef="let product"> {{product.sku}} </td>
        </ng-container>

        <!-- Coluna Nome -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Nome </th>
          <td mat-cell *matCellDef="let product"> {{product.name}} </td>
        </ng-container>

        <!-- Product Type Column -->
        <ng-container matColumnDef="productType">
          <th mat-header-cell *matHeaderCellDef> Tipo </th>
          <td mat-cell *matCellDef="let product">
            <mat-chip [ngClass]="{
              'type-materia-prima': product.productType === 'MATERIA_PRIMA',
              'type-fabrico-proprio': product.productType === 'FABRICO_PROPRIO',
              'type-revenda': product.productType === 'REVENDA'
            }">
              {{getProductTypeLabel(product.productType)}}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Technical Difficulty Column -->
        <ng-container matColumnDef="technicalDifficulty">
          <th mat-header-cell *matHeaderCellDef> Dificuldade </th>
          <td mat-cell *matCellDef="let product"> {{product.technicalDifficulty}} </td>
        </ng-container>

        <!-- Current Stock Column -->
        <ng-container matColumnDef="currentStock">
          <th mat-header-cell *matHeaderCellDef> Estoque </th>
          <td mat-cell *matCellDef="let product"> {{product.currentStock}} </td>
        </ng-container>

        <!-- Unit of Measure Column -->
        <ng-container matColumnDef="isDivisible">
          <th mat-header-cell *matHeaderCellDef> Divisível? </th>
          <td mat-cell *matCellDef="let product"> {{product.isDivisible ? 'Sim' : 'Não'}} </td>
        </ng-container>

        <!-- Average Cost Column -->
        <ng-container matColumnDef="averageCost">
          <th mat-header-cell *matHeaderCellDef matTooltip="Custo Médio"> Custo </th>
          <td mat-cell *matCellDef="let product"> {{product.averageCost | currency:'EUR'}} </td>
        </ng-container>

        <!-- PvP Mínimo Column -->
        <ng-container matColumnDef="calculatedMinPrice">
          <th mat-header-cell *matHeaderCellDef> PvP Mín. </th>
          <td mat-cell *matCellDef="let product"> 
            <span [ngClass]="{
              'price-warning': !product.calculatedMinPrice && product.productType !== 'MATERIA_PRIMA',
              'not-applicable': product.productType === 'MATERIA_PRIMA'
            }">
              {{product.calculatedMinPrice ? (product.calculatedMinPrice | currency:'EUR':'symbol':'1.2-2') : 
                (product.productType === 'MATERIA_PRIMA' ? '-' : 'N/A')}}
            </span>
          </td>
        </ng-container>

        <!-- PvP Recomendado Column -->
        <ng-container matColumnDef="calculatedRecommendedPrice">
          <th mat-header-cell *matHeaderCellDef> PvP Rec. </th>
          <td mat-cell *matCellDef="let product"> 
            <span [ngClass]="{
              'price-success': product.calculatedRecommendedPrice,
              'not-applicable': product.productType === 'MATERIA_PRIMA'
            }">
              {{product.calculatedRecommendedPrice ? (product.calculatedRecommendedPrice | currency:'EUR':'symbol':'1.2-2') : 
                (product.productType === 'MATERIA_PRIMA' ? '-' : 'N/A')}}
            </span>
          </td>
        </ng-container>

        <!-- Lucro Mínimo Column -->
        <ng-container matColumnDef="minProfitAmount">
          <th mat-header-cell *matHeaderCellDef> Lucro Mín. </th>
          <td mat-cell *matCellDef="let product"> 
            <span [ngClass]="{
              'not-applicable': product.productType === 'MATERIA_PRIMA'
            }">
              {{product.minProfitAmount ? (product.minProfitAmount | currency:'EUR':'symbol':'1.2-2') : 
                (product.productType === 'MATERIA_PRIMA' ? '-' : 'N/A')}}
            </span>
          </td>
        </ng-container>

        <!-- Coluna Status -->
        <ng-container matColumnDef="isActive">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let product">
            {{ product.isActive ? 'Ativo' : 'Inativo' }}
          </td>
        </ng-container>

        <!-- Main Image Column -->
        <ng-container matColumnDef="mainImageUrl">
          <th mat-header-cell *matHeaderCellDef>Imagem</th>
          <td mat-cell *matCellDef="let element">
            <img [src]="
                element.mainImageUrl ||
                'https://placehold.co/40x40.png?text=Sem+Foto'
              " loading="lazy" width="40" height="40" alt="Imagem do Artigo" class="product-image"
              (click)="showLargeImage(element.mainImageUrl, element)" />
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Ações </th>
          <td mat-cell *matCellDef="let product">
            <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Opções do produto">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="editProduct(product)">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>
              <button mat-menu-item (click)="viewStockHistory(product)">
                <mat-icon>history</mat-icon>
                <span>Ver Histórico</span>
              </button>
              <button mat-menu-item (click)="toggleProductStatus(product)">
                <mat-icon [color]="product.isActive ? 'warn' : 'primary'">
                  {{ product.isActive ? 'toggle_off' : 'toggle_on' }}
                </mat-icon>
                <span>{{ product.isActive ? 'Desativar' : 'Ativar' }}</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let product; columns: displayedColumns;" [class.inactive-row]="!product.isActive"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell table-empty-row" align="center" [attr.colspan]="displayedColumns.length">Nenhum artigo
            encontrado.</td>
        </tr>
      </table>
    </div>
  </mat-card-content>
</mat-card>